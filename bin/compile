#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

START_TIME=$SECONDS

# set bash options
set -o errexit  # always exit on error
set -o pipefail # don't ignore exit code when use pipe


# configure directories
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ../; pwd)

# set optional config variables
: ${EMBULK_BUILDPACK_DEBUG:="false"}

source $BP_DIR/lib/common.sh

# functions
install_embulk() {
    log "Downloading embulk jar ..."
    curl --create-dirs -o $BUILD_DIR/vendor/bin/embulk -L "https://dl.embulk.org/embulk-latest.jar"

    log "Set executable parmission ..."
    chmod +x $BUILD_DIR/vendor/bin/embulk
}


setup_dirs() {
    export PATH="$BUILD_DIR/vendor/bin:$PATH"
}

header 'Welcome to heroku-embulk-buildpack!'

log "Setting up paths ..."

debug "BUILD_DIR: $BUILD_DIR"
debug "CACHE_DIR: $CACHE_DIR"
debug "ENV_DIR: $ENV_DIR"
debug "BP_DIR: $BP_DIR"


setup_dirs
log "Starting embulk Installation ..."
install_embulk

# Create .profile.d folder
mkdir -p $BUILD_DIR/.profile.d

# if no .profile.d/path.sh, create one
if [ ! -f $BUILD_DIR/.profile.d/path.sh ]; then
    log "Creating path.sh ..."
    echo "echo \"Updating PATH to include embulk ...\"
export PATH=\$PATH:/app/vendor/bin" > $BUILD_DIR/.profile.d/path.sh

    log "Generated $BUILD_DIR/.profile.d/path.sh to add embulk path"
fi

header "DONE! COmpleted in $(($SECONDS - $START_TIME))s"

exit 0

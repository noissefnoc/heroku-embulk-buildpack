#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

START_TIME=$SECONDS

# set bash options
set -o errexit  # always exit on error
set -o pipefail # don't ignore exit code when use pipe


# configure directories
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ../; pwd)

# set optional config variables
: ${EMBULK_BUILDPACK_DEBUG:="false"}

source $BP_DIR/lib/common.sh

# from heroku/java buildpack lib/common.sh
# ref) https://github.com/heroku/heroku-buildpack-java
install_jdk() {
    local install_dir=${1}
    log "Downloading and installing jdk ..."

    JVM_COMMON_BUILDPACK=${JVM_COMMON_BUILDPACK:-https://codon-buildpacks.s3.amazonaws.com/buildpacks/heroku/jvm-common.tgz}
    mkdir -p /tmp/jvm-common
    curl --retry 3 --silent --location $JVM_COMMON_BUILDPACK | tar xzm -C /tmp/jvm-common --strip-components=1
    source /tmp/jvm-common/bin/util
    source /tmp/jvm-common/bin/java
    source /tmp/jvm-common/opt/jdbc.sh

    install_java_with_overlay ${install_dir}
}

# functions
install_embulk() {
    local install_dir=${1}

    log "Downloading embulk jar ..."
    curl --create-dirs -o ${install_dir}/vendor/bin/embulk -L "https://dl.embulk.org/embulk-latest.jar" 2> /dev/null

    log "Set executable parmission ..."
    chmod +x ${install_dir}/vendor/bin/embulk
}

install_gems() {
    local install_dir=${1}

    log "Checking Gemfile..."
    if [ -e "bundle_dir" ]; then
        cd "bundle_dir"
        embulk bundle
        log "Embulk bundle install done ..."
    else
        log "nothing to install ..."
    fi
}

setup_dirs() {
    export PATH="$BUILD_DIR/vendor/bin:$PATH"
}

header 'Welcome to heroku-embulk-buildpack!'

section "Setting up paths ..."

debug "BUILD_DIR: $BUILD_DIR"
debug "CACHE_DIR: $CACHE_DIR"
debug "ENV_DIR: $ENV_DIR"
debug "BP_DIR: $BP_DIR"

setup_dirs

log "Setting up paths done ..."

section "Starting jdk Installation ..."
install_jdk ${BUILD_DIR}
log "Starting jdk Installation done ..."

section "Starting embulk Installation ..."
install_embulk ${BUILD_DIR}
log "Starting embulk Installation done ..."

section "Add PATH ..."
# Create .profile.d folder
mkdir -p ${BUILD_DIR}/.profile.d

# if no .profile.d/path.sh, create one
if [ ! -f ${BUILD_DIR}/.profile.d/path.sh ]; then
    log "Creating path.sh ..."
    echo "echo \"Updating PATH to include embulk ...\"
export PATH=\$PATH:/app/vendor/bin" > ${BUILD_DIR}/.profile.d/path.sh

    log "Generated ${BUILD_DIR}/.profile.d/path.sh to add embulk path"
fi

section "Starting Gem Installation ..."
install_gems ${BUILD_DIR}
log "Starting Gem Installation done ..."

header "DONE! Completed in $(($SECONDS - $START_TIME))s"

exit 0
